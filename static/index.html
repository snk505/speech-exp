<script>
  const API_BASE = ""; // same origin (this app serves API and UI)
  // If youâ€™re using presigned PUT:
  async function saveRecordingPUT(blob) {
    const ct = blob.type || "application/octet-stream";
    const key = `sub${pid}_${String(i+1).padStart(3,'0')}_${slug(SENTS[i])}_${phase===0?'EN':'YUE'}.webm`;

    const r = await fetch(`${API_BASE}/sign`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ pid, key, content_type: ct })
    });
    const { url } = await r.json();

    const up = await fetch(url, { method:"PUT", headers: { "Content-Type": ct }, body: blob });
    if (!up.ok) throw new Error("upload failed: "+up.status);
  }

  // OR if you switch to presigned POST (no preflight):
  async function saveRecordingPOST(blob) {
    const key = `sub${pid}_${String(i+1).padStart(3,'0')}_${slug(SENTS[i])}_${phase===0?'EN':'YUE'}.webm`;
    const r = await fetch(`${API_BASE}/sign_post`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ pid, key })
    });
    const { url, fields } = await r.json();

    const fd = new FormData();
    Object.entries(fields).forEach(([k,v]) => fd.append(k, v));
    fd.append("file", new File([blob], "rec.webm")); // don't set Content-Type header

    const up = await fetch(url, { method:"POST", body: fd });
    if (!(up.status === 201 || up.status === 204 || up.ok)) {
      throw new Error("upload POST failed: "+up.status);
    }
  }
</script>
