<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ó–∞–ø–∏—Å—å —Ä–µ—á–∏</title>
  <style>
    body { font-family: Segoe UI, Arial, sans-serif; background: #fff; color:#000; margin:0; }
    .wrap { max-width: 760px; margin: 0 auto; padding:16px; }
    .card { border:1px solid #ccc; border-radius:10px; padding:12px; margin-top:12px; }
    button { cursor:pointer; }
  </style>
</head>
<body>
<div class="wrap">
  <h2>–ó–∞–ø–∏—Å—å —Ä–µ—á–∏</h2>
  <div style="font-size:15px;margin-bottom:12px;">–í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π: <span id="totalN"></span></div>

  <!-- Screen 0: Mic Check -->
  <div id="scrMic" class="card">
    <div style="font-weight:700;margin-bottom:8px;">–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</div>
    <div style="margin-bottom:10px;">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∏ —Å–¥–µ–ª–∞–π—Ç–µ –∫–æ—Ä–æ—Ç–∫—É—é —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å. –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.</div>
    <div style="display:flex;gap:8px;margin:8px 0;">
      <button id="micEnable" style="padding:8px 12px;border-radius:6px;background:#2563eb;color:#fff;border:0">–†–∞–∑—Ä–µ—à–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
      <button id="micRec"  style="padding:8px 12px;border-radius:6px;background:#16a34a;color:#fff;border:0">üî¥ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
      <button id="micStop" disabled style="padding:8px 12px;border-radius:6px;background:#dc2626;color:#fff;border:0">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <button id="micNext" disabled style="margin-left:auto;padding:8px 12px;border-radius:6px;background:#111827;color:#fff;border:0">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>
    <div id="micStatus" style="padding:8px;border:1px dashed #999;border-radius:6px;">–û–∂–∏–¥–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω‚Ä¶</div>
    <div id="micPlayer" style="margin-top:10px"></div>
  </div>

  <!-- Screen 1: Participant ID -->
  <div id="scrId" class="card" style="display:none;">
    <label style="font-weight:600;">–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞ (–∏–º—è –Ω–∞ –ª–∞—Ç–∏–Ω–∏—Ü–µ + –≤–æ–∑—Ä–∞—Å—Ç):</label>
    <input id="pid" type="text" placeholder="Ivan24" style="margin:0 8px;padding:6px 10px;border:1px solid #888;border-radius:6px">
    <button id="go" style="padding:6px 12px;border-radius:6px;background:#2563eb;color:#fff;border:0">–ù–∞—á–∞—Ç—å</button>
    <div id="warn" style="color:#b91c1c;display:none;margin-top:6px">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–Ω–µ –ø—É—Å—Ç–æ–π).</div>
    <div id="pidTaken" style="color:#b91c1c;display:none;margin-top:6px"></div>
  </div>

  <!-- Screen 2: Task -->
  <div id="scrTask" class="card" style="display:none;">
    <div id="prog" style="font-size:14px;margin-bottom:4px;"></div>
    <div id="phaseLabel" style="font-weight:700;margin:6px 0;"></div>
    <div id="hint" style="margin-bottom:12px;font-size:15px;"></div>

    <div class="card" style="background:#fff;">
      <div id="promptLabel" style="font-size:13px;margin-bottom:4px;">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:</div>
      <div id="sent" style="font-size:19px;line-height:1.5;"></div>
    </div>

    <div style="display:flex;gap:8px;margin:8px 0">
      <button id="rec"  style="padding:8px 12px;border-radius:6px;background:#16a34a;color:#fff;border:0">üî¥ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
      <button id="stop" disabled style="padding:8px 12px;border-radius:6px;background:#dc2626;color:#fff;border:0">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <button id="save" disabled style="padding:8px 12px;border-radius:6px;background:#2563eb;color:#fff;border:0">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>

    <div id="status" style="padding:8px;border:1px dashed #999;border-radius:6px;">–ì–æ—Ç–æ–≤–æ‚Ä¶</div>
    <div id="player" style="margin-top:10px"></div>
  </div>

  <!-- Screen 3: Done -->
  <div id="scrDone" class="card" style="display:none;">
    <b style="color:#16a34a;">‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ –≤ –æ–ø—Ä–æ—Å–µ! –°–µ–∞–Ω—Å –∑–∞–ø–∏—Å–∏ –∑–∞–≤–µ—Ä—à—ë–Ω.</b>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const API_BASE = "https://monkfish-app-c8mpr.ondigitalocean.app";

// Stage 1: Russian sentences only
const RUS_SENTS = [
  "–ù–∞—Å—Ç—É–ø–∏–ª–∞ –æ—Å–µ–Ω—å.",
  "–ê–Ω—Ç–æ–Ω —Å—Ç–æ–∏—Ç –Ω–∞ –º–æ—Å—Ç—É.",
  "–ö–∞–∫–∞—è –∑–∞–≤—Ç—Ä–∞ –±—É–¥–µ—Ç –ø–æ–≥–æ–¥–∞?",
  "–ì–¥–µ –º–æ–∂–Ω–æ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å?",
  "–ú–æ–∂–Ω–æ —è –ø–æ–π–¥—É –≤ –∫–∏–Ω–æ?",
  "–û–Ω –ø—Ä–∏–µ–¥–µ—Ç –≤ –ø—è—Ç–Ω–∏—Ü—É –∏–ª–∏ –≤ —Å—É–±–±–æ—Ç—É?",
  "–ê –Ω–∞ —à–µ—Å—Ç–æ–º —ç—Ç–∞–∂–µ?",
  "–í–∞—à–µ –∏–º—è? (–ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)",
  "–ö–∞–∫–æ–π —Å–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å!",
  "–°–∫–æ–ª—å–∫–æ –¥–æ–±—Ä–æ—Ç—ã –≤ –Ω–µ–º!",
  "–ö–∞–∫–æ–π –≤–∫—É—Å–Ω—ã–π —Å–æ–∫!",
  "–°–∫–æ–ª—å–∫–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤!",
  "–ö–∞–∫–æ–π –æ–Ω –æ—Ç–ª–∏—á–Ω–∏–∫! (—Ç–æ –µ—Å—Ç—å –æ–Ω –Ω–µ –æ—Ç–ª–∏—á–Ω–∏–∫)",
  "–î–∞ –∫–∞–∫–∞—è –æ–Ω–∞ –∞–∫—Ç—Ä–∏—Å–∞! (—Ç–æ –µ—Å—Ç—å –æ–Ω–∞ –Ω–µ –∞–∫—Ç—Ä–∏—Å–∞)"
];

// Stage 2: Russian text(s)
const TEXTS = [
  {
    title: "–¢–µ–∫—Å—Ç A",
    body: `–Ø —É—á—É—Å—å –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ. –ò –º–æ–∏ –¥—Ä—É–∑—å—è —É—á–∞—Ç—Å—è –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ. –ë–æ—Ä–∏—Å - —ç–∫–æ–Ω–æ–º–∏—Å—Ç, –°–µ—Ä–≥–µ–π - —é—Ä–∏—Å—Ç, –∞ –ò–≤–∞–Ω - –∏–Ω–∂–µ–Ω–µ—Ä. –ú—ã –∂–∏–≤–µ–º —Ä—è–¥–æ–º, –≤–æ–∑–ª–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –ø–ª–æ—â–∞–¥–∏. –í —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è –º—ã —Ö–æ–¥–∏–º –≤ –∫–∏–Ω–æ, –≤ –ø–∞—Ä–∫, –≤ –∫–ª—É–±, —Å–ª—É—à–∞–µ–º –ª–µ–∫—Ü–∏–∏. –ß–∞—Å—Ç–æ –º—ã —Å–æ–±–∏—Ä–∞–µ–º—Å—è —É
–º–µ–Ω—è –∏–ª–∏ —É –°–µ—Ä–≥–µ—è, –∏–≥—Ä–∞–µ–º –≤ —à–∞—Ö–º–∞—Ç—ã, —Å–º–æ—Ç—Ä–∏–º —Ç–µ–ª–µ–≤–∏–∑–æ—Ä. –°–µ–≥–æ–¥–Ω—è —Å—É–±–±–æ—Ç–∞. –ß–µ—Ç—ã—Ä–µ —á–∞—Å–∞. –ú—ã –∂–¥–µ–º –ò–≤–∞–Ω–∞. –û–Ω –ø–æ—Å—Ç—É–ø–∞–µ—Ç –≤ –º–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—É –∏ —Å–µ–≥–æ–¥–Ω—è —Å–¥–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–∫–∑–∞–º–µ–Ω. –í–æ—Ç –∑–≤–æ–Ω–∏—Ç –∑–≤–æ–Ω–æ–∫.
- –ù—É –∫–∞–∫ –¥–µ–ª–∞? –°–¥–∞–ª?
- –í—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ! –°–¥–∞–ª! 
–ú—ã —Å–∞–¥–∏–º—Å—è –ø–∏—Ç—å —á–∞–π.`
  }
];

// Two stages, one recording per item
const STAGES = [
  {
    name: "–≠—Ç–∞–ø 1 ‚Äî –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º",
    promptLabel: "Sentence:",      // keep for existing kindTag logic
    promptLabelRu: "–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:",
    hint: "–ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ-—Ä—É—Å—Å–∫–∏ –û–î–ò–ù –†–ê–ó. –°–ª–æ–≤–∞ –≤ —Å–∫–æ–±–∫–∞—Ö —á–∏—Ç–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å.",
    items: RUS_SENTS.map((s, idx) => ({ id: `sent${idx+1}`, body: s }))
  },
  {
    name: "–≠—Ç–∞–ø 2 ‚Äî –¢–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º",
    promptLabel: "Text:",          // keep for existing kindTag logic
    promptLabelRu: "–¢–µ–∫—Å—Ç:",
    hint: "–ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ-—Ä—É—Å—Å–∫–∏ –≤ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —Ç–µ–º–ø–µ.",
    items: TEXTS.map((t, idx) => ({ id: `text${idx+1}`, body: t.body, title: t.title }))
  }
];
/* =================== */

const $ = id => document.getElementById(id);
const show = (el,vis)=> el.style.display = vis ? "block" : "none";

function extFromMime(m){
  const t = (m||"").toLowerCase();
  if (t.includes("ogg")) return "ogg";
  if (t.includes("webm")) return "webm";
  if (t.includes("mp4")) return "m4a";
  if (t.includes("mpeg") || t.includes("mp3")) return "mp3";
  if (t.includes("wav")) return "wav";
  return "dat";
}

// Display counts (optional)
$("totalN").textContent = `${RUS_SENTS.length} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π + ${TEXTS.length} —Ç–µ–∫—Å—Ç(–æ–≤)`;

/* ===== State ===== */
let stage = 0;   // 0..STAGES.length-1
let item  = 0;   // 0..items.length-1
let pid = "";

let rec = null, chunks = [], mime = "", blobForSave = null;

// Mic check
let micRec=null, micChunks=[], micMime="", micReady=false;

/* ===== Mic Check ===== */
$("micEnable").onclick = async ()=>{
  try{
    const s = await navigator.mediaDevices.getUserMedia({audio:true});
    s.getTracks().forEach(t=>t.stop());
    micReady = true;
    $("micStatus").textContent = "‚úÖ –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É —Ä–∞–∑—Ä–µ—à—ë–Ω.";
    $("micNext").disabled = false;
  }catch(e){
    $("micStatus").textContent = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: " + (e && e.message || e);
  }
};

$("micRec").onclick = async ()=>{
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    const prefs = ['audio/webm;codecs=opus','audio/ogg;codecs=opus','audio/mp4'];
    let chosen=''; for(const t of prefs){ if(MediaRecorder.isTypeSupported(t)){ chosen=t; break; } }
    micRec = new MediaRecorder(stream, chosen?{mimeType:chosen}:undefined);
    micMime = micRec.mimeType || chosen || '';
    micChunks = [];
    micRec.ondataavailable = e=>{ if(e.data?.size) micChunks.push(e.data); };
    micRec.onstop = ()=>{
      const b = new Blob(micChunks,{type:micMime||'audio/webm'});
      $("micPlayer").innerHTML = '<audio controls src="'+URL.createObjectURL(b)+'" style="width:100%"></audio>';
      $("micStop").disabled = true;
      micReady = true;
      $("micNext").disabled = false;
      $("micStatus").textContent = "‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≥–æ—Ç–æ–≤–∞ (–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è).";
      stream.getTracks().forEach(t=>t.stop());
    };
    micRec.start();
    $("micStop").disabled = false;
    $("micStatus").textContent = "üî¥ –ò–¥—ë—Ç —Ç–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å‚Ä¶";
  }catch(e){
    $("micStatus").textContent = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å: " + (e && e.message || e);
  }
};

$("micStop").onclick = ()=>{ if(micRec && micRec.state==='recording') micRec.stop(); };

$("micNext").onclick = ()=>{
  if(!micReady){
    $("micStatus").textContent = "‚ùå –°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏–ª–∏ —Å–¥–µ–ª–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å.";
    return;
  }
  show($("scrMic"), false);
  show($("scrId"), true);
};

/* ===== ID Screen ===== */
$("go").onclick = async ()=>{
  const v = ($("pid").value||"").trim();
  $("pidTaken").style.display = "none";
  
  // –†–∞–∑—Ä–µ—à–∞–µ–º —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã –∏ –ø—Ä–æ–±–µ–ª—ã, –Ω–æ –∑–∞–ø—Ä–µ—â–∞–µ–º —Å–æ–≤—Å–µ–º "–ø—É—Å—Ç–æ–µ" –∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ
  if(!v){ $("warn").style.display = "block"; return; }
  
  $("warn").style.display = "none";
  pid = v; // –æ—Å—Ç–∞–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è/–ª–æ–≥–∏–∫–∏


  stage = 0; item = 0;

  show($("scrId"), false);
  show($("scrTask"), true);
  render();
};

/* ===== Render ===== */
function render(){
  const st = STAGES[stage];
  const it = st.items[item];

  $("prog").textContent = `${st.name} ‚Äî –ü—É–Ω–∫—Ç ${item+1} –∏–∑ ${st.items.length}`;
  $("phaseLabel").textContent = st.name;           // reuse existing slot
  $("hint").textContent = st.hint;

  $("promptLabel").textContent = st.promptLabelRu || (st.promptLabel.toLowerCase().includes("text") ? "–¢–µ–∫—Å—Ç:" : "–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:");

  $("sent").textContent = it.body;
  $("sent").style.whiteSpace = "pre-wrap"; // keep line breaks for text stage

  $("player").innerHTML = "";
  $("save").disabled = true;
  $("status").textContent = "–ì–æ—Ç–æ–≤–æ‚Ä¶";
  blobForSave = null;
}

/* ===== Recording ===== */
$("rec").onclick = async ()=>{
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    const prefs = ['audio/webm;codecs=opus','audio/ogg;codecs=opus','audio/mp4'];
    let chosen=''; for(const t of prefs){ if(MediaRecorder.isTypeSupported(t)){ chosen=t; break; } }
    rec = new MediaRecorder(stream, chosen?{mimeType:chosen}:undefined);
    mime = rec.mimeType || chosen || '';
    chunks = [];
    blobForSave = null;

    rec.ondataavailable = e => { if(e.data?.size) chunks.push(e.data); };
    rec.onstop = ()=>{
      const b = new Blob(chunks,{type:mime||'audio/webm'});
      blobForSave = b;
      $("player").innerHTML = '<audio controls src="'+URL.createObjectURL(b)+'" style="width:100%"></audio>';
      $("save").disabled = false;
      $("status").textContent = "‚úÖ –ó–∞–ø–∏—Å—å –≥–æ—Ç–æ–≤–∞ –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é.";
      stream.getTracks().forEach(t=>t.stop());
    };

    rec.start();
    $("rec").disabled = true;
    $("stop").disabled = false;
    $("save").disabled = true;
    $("status").textContent = "üî¥ –ò–¥—ë—Ç –∑–∞–ø–∏—Å—å‚Ä¶";
  }catch(e){
    $("status").textContent = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: " + (e && e.message || e);
  }
};

$("stop").onclick = ()=>{
  if(rec && rec.state==='recording'){
    rec.stop();
    $("rec").disabled = false;
    $("stop").disabled = true;
  }
};

function slugCyrillic(s){
  // Keep letters (Latin/Cyrillic), numbers, _ and -, replace spaces with _
  // Remove punctuation to avoid ugly URLs. Limit length.
  return (s || "")
    .normalize("NFKC")
    .trim()
    .replace(/\s+/g, "_")
    .replace(/[^0-9A-Za-z_\-\u0400-\u04FF\u0500-\u052F\u2DE0-\u2DFF\uA640-\uA69F]/g, "")
    .replace(/_+/g, "_")
    .slice(0, 60) || "sent";
}
function pidKeySafe(pidRaw){
  // –†–∞–∑—Ä–µ—à–∞–µ–º –∫–∏—Ä–∏–ª–ª–∏—Ü—É + –ª–∞—Ç–∏–Ω–∏—Ü—É + —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏–º –≤ _
  // –£–±–µ—Ä—ë–º –æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è –∫–ª—é—á–µ–π/–æ–±—Ä–∞–±–æ—Ç–∫–∏.
  return (pidRaw || "")
    .normalize("NFKC")
    .trim()
    .replace(/\s+/g, "_")
    .replace(/[^0-9A-Za-z_\-\u0400-\u04FF\u0500-\u052F\u2DE0-\u2DFF\uA640-\uA69F]/g, "")
    .slice(0, 60) || "participant";
}


/* ===== Save via presigned URL ===== */
async function saveRecording(){
  if(!blobForSave){
    $("status").textContent = "‚ùå –ù–µ—Ç –∑–∞–ø–∏—Å–∏.";
    advance();
    return;
  }

  $("status").textContent = "‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶";

  const st = STAGES[stage];
  const it = st.items[item];

  try{
    const ext = extFromMime(blobForSave.type);
    const stageTag = `S${stage+1}`;
    const itemTag = `I${String(item+1).padStart(3,'0')}`;
    const kindTag = st.promptLabel.toLowerCase().includes("text") ? "TEXT" : "SENT";

    const name = (kindTag === "TEXT") ? "text" : slugCyrillic(it.body);
    const key  = `sub${pid}_${stageTag}_${itemTag}_${kindTag}_${name}_${it.id}.${ext}`;

    const r = await fetch(`${API_BASE}/sign`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        pid,
        key,
        content_type: blobForSave.type || `audio/${ext}`
      })
    });
    if(!r.ok) throw new Error("sign failed");
    const { url } = await r.json();

    const put = await fetch(url, {
      method: "PUT",
      headers: { "Content-Type": blobForSave.type || `audio/${ext}` },
      body: blobForSave
    });
    if(!put.ok) throw new Error("upload failed");

    $("status").textContent = "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.";
  }catch(e){
    $("status").textContent = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –¥–∞–ª—å—à–µ.";
  }

  advance();
}

$("save").onclick = saveRecording;

/* ===== Advance across items then stages ===== */
function advance(){
  const st = STAGES[stage];

  item++;
  if(item < st.items.length){
    render();
    return;
  }

  item = 0;
  stage++;
  if(stage < STAGES.length){
    render();
    return;
  }

  show($("scrTask"), false);
  show($("scrDone"), true);
}
</script>
</body>
</html>
